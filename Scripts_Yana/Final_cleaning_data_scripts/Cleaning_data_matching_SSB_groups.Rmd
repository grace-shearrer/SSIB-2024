# Libraries

```{r, message = FALSE, warning=FALSE}
library(tidyverse)
library(plyr)
library(dplyr)
library(childsds)
library(MatchIt)
library(vroom)
```

# Reading data

## Sugary beverage intake

### Grace Redo
I am unable to get your code generate results (it just becomes blank). I think probably you have a saved dataset that is in memory but not saved on the drive. This is also why you need to keep you data on the drive and use the data from the drive. If you keep doing this locally I can't help you and I end up re-doing everything. 

# Read in all the data at the same time
```{r}
soda_data <-vroom("~/OneDrive - University of Wyoming/0. Lab/M2AENAD Lab - Documents/RESEARCH/ABCD/Yana_SSIB_2024/data/raw/abcd_bkfs01.txt")
anthro_data <-vroom("~/OneDrive - University of Wyoming/0. Lab/M2AENAD Lab - Documents/RESEARCH/ABCD/Yana_SSIB_2024/data/raw/abcd_ant01.txt")
demo_data <-vroom("~/OneDrive - University of Wyoming/0. Lab/M2AENAD Lab - Documents/RESEARCH/ABCD/Yana_SSIB_2024/data/raw/pdem02.txt")
brain_data <-vroom("~/OneDrive - University of Wyoming/0. Lab/M2AENAD Lab - Documents/RESEARCH/ABCD/Yana_SSIB_2024/data/raw/abcd_betnet02.txt")
subcort_brain_data <-vroom("~/OneDrive - University of Wyoming/0. Lab/M2AENAD Lab - Documents/RESEARCH/ABCD/Yana_SSIB_2024/data/raw/mrirscor02.txt")
screen_data <-vroom("~/OneDrive - University of Wyoming/0. Lab/M2AENAD Lab - Documents/RESEARCH/ABCD/Yana_SSIB_2024/data/raw/abcd_screen01.txt")
med_data<-vroom("/Users/gracer/Library/CloudStorage/GoogleDrive-graceshearrer@gmail.com/Other computers/UNC_iMac/Desktop/ABCD_RELEASE_1/abcd_mx01.txt")
med_data <- med_data[-1, ]
```

# Create a quick data dict
```{r}
DD<-cbind(head(soda_data,1), head(anthro_data, 1), head(demo_data,1), head(brain_data, 1), head(subcort_brain_data,1), head(anthro_data_2,1))
DT <-data.frame(t(DD))
DT$variable = row.names(DT) 
names(DT)[c(1, 2)] <- c("variable", "description")

#write.table(DT, "~/OneDrive - University of Wyoming/0. Lab/M2AENAD Lab - Documents/RESEARCH/ABCD/Yana_SSIB_2024/data/dataDict.csv", sep = ",", row.names = FALSE)

write.table(DT, r"(C:\Users\Yanko\University of Wyoming\M2AENAD Lab - Documents\M2AENAD Lab - Documents\RESEARCH\ABCD\Yana_SSIB_2024/data/dataDict.csv)", sep = ",", row.names = FALSE)

```

# First screen on obvious 
## Start n = 11875
Checking for ADHD, neurological condition, type 1 diabetes, muscle dystrophy, schizophrenia, autism
abcd_screen01
- scrn_cpalsy
-- n = 11867
- scrn_hemorrhage
-- n = 11863
- scrn_medcond_other
-- n = 11626
- scrn_asd
-- n = 11400
- scrn_schiz
-- 11397
- scrn_tumor
-- 11395
- scrn_stroke
- scrn_aneurysm
- scrn_hemorrhage
- scrn_hemotoma
- scrn_medcond_other
- scrn_schiz


```{r}
screen_data1 <-subset(screen_data, screen_data$scrn_cpalsy != 0)
screen_data2 <- subset(screen_data1, screen_data1$scrn_hemorrhage != 0)
screen_data3 <- subset(screen_data2, screen_data2$scrn_medcond_other != 1)
screen_data4 <- subset(screen_data3, screen_data3$scrn_asd != 1)
screen_data5 <- subset(screen_data4, screen_data4$scrn_schiz != 1)
screen_data6 <- subset(screen_data5, screen_data5$scrn_tumor != 0)
screen_data7 <- subset(screen_data6, screen_data6$scrn_stroke != 0)
screen_data8 <- subset(screen_data7, screen_data7$scrn_aneurysm != 0)
screen_data9 <- subset(screen_data8, screen_data8$scrn_hemotoma != 0)
screen_data10 <- subset(screen_data9, screen_data9$scrn_medcond_other != 1)
screen_df<-screen_data10
```
abcd_mx01
- MusDys medhx_2l
- MS medhx_2m
- medhx_2k lead poisoning
- kidney disease medhx_2j
- cancer medhx_2e
- medhx_2g diabetes
- cere pals medhx_2f
- medhx_2o heart
```{r}
med_data <- med_data[med_data$eventname == 'baseline_year_1_arm_1',]
screen_med_data<-join(med_data, screen_df)
####
summary(as.factor(screen_med_data$medhx_2o))
screen_med_data1<-subset(screen_med_data, screen_med_data$medhx_2l != 1)
screen_med_data2<-subset(screen_med_data1, screen_med_data1$medhx_2m != 1)
screen_med_data3<-subset(screen_med_data2, screen_med_data2$medhx_2k != 1)
screen_med_data4<-subset(screen_med_data3, screen_med_data3$medhx_2j != 1)
screen_med_data5<-subset(screen_med_data4, screen_med_data4$medhx_2e != 1)
screen_med_data6<-subset(screen_med_data5, screen_med_data5$medhx_2g != 1)
screen_med_data7<-subset(screen_med_data6, screen_med_data6$medhx_2f != 1)
screen_med_data8<-subset(screen_med_data7, screen_med_data7$medhx_2o != 1)
screen_med_df<-screen_med_data8
```

```{r}
save.image(file = "/Users/gracer/Library/CloudStorage/OneDrive-UniversityofWyoming/0. Lab/M2AENAD Lab - Documents/RESEARCH/ABCD/Yana_SSIB_2024/data/screening.RData")
```




# Filter by event then drop event column
We are going to try to predict the SSB intake from the baseline data so we want baseline for the brain data
```{r}
soda_data <- soda_data[soda_data$eventname == '2_year_follow_up_y_arm_1',]
brain_data <- brain_data[brain_data$eventname == 'baseline_year_1_arm_1',]
demo_data <- demo_data[demo_data$eventname == 'baseline_year_1_arm_1',]
subcort_brain_data <- subcort_brain_data[subcort_brain_data$eventname == 'baseline_year_1_arm_1',]
anthro_data <- anthro_data[anthro_data$eventname == 'baseline_year_1_arm_1',]
```

# demographics of interest
household income
1= Less than $5,000; 2=$5,000 through $11,999; 3=$12,000 through $15,999; 4=$16,000 through $24,999; 5=$25,000 through $34,999; 6=$35,000 through $49,999; 7=$50,000 through $74,999; 8= $75,000 through $99,999; 9=$100,000 through $199,999; 10=$200,000 and greater. 999 = Don't know  777 = Refuse to answer 
```{r}
demo_data<-subset(demo_data, demo_data$demo_comb_income_v2 != "777")
demo_data<-subset(demo_data, demo_data$demo_comb_income_v2 != "999")
```

```{r}
demos<-c("subjectkey", "sex", "interview_age", "demo_race_a_p___10", "demo_race_a_p___11", "demo_race_a_p___12",          "demo_race_a_p___13", "demo_race_a_p___14", "demo_race_a_p___15", "demo_race_a_p___16", "demo_race_a_p___17",         
 "demo_race_a_p___18", "demo_race_a_p___19", "demo_race_a_p___20", "demo_race_a_p___21", "demo_race_a_p___22",  "demo_race_a_p___23", "demo_race_a_p___24", "demo_comb_income_v2") 
demo_df<-demo_data[demos]
head(demo_df)
columns_to_sum <- c("demo_race_a_p___10", "demo_race_a_p___11", "demo_race_a_p___12",
                    "demo_race_a_p___13", "demo_race_a_p___14", "demo_race_a_p___15",
                    "demo_race_a_p___16", "demo_race_a_p___17", "demo_race_a_p___18",
                    "demo_race_a_p___19", "demo_race_a_p___20", "demo_race_a_p___21",
                    "demo_race_a_p___22", "demo_race_a_p___23", "demo_race_a_p___24")

# Convert specified columns to numeric
demo_df[columns_to_sum] <- lapply(demo_df[columns_to_sum], as.numeric)

# Calculate the sum across the specified columns for each row
demo_df$row_sum <- rowSums(demo_df[, columns_to_sum], na.rm = TRUE)
summary(as.factor(demo_df$row_sum))
demo_df$multiRacial <- ifelse(demo_df$row_sum > 1, 1, 0)
summary(as.factor(demo_df$multiRacial))
multi<-subset(demo_df, demo_df$multiRacial == 1)
multi$race<-multi$multiRacial*16
##################################################
single<-subset(demo_df, demo_df$multiRacial == 0)
#1 = white
single$race_white<-single$demo_race_a_p___10*1
#2 = black
single$race_black<-single$demo_race_a_p___11*2
#3 = native american
single$race_AmIn<-single$demo_race_a_p___12*3
#4 = native alaska
single$race_NaAl<-single$demo_race_a_p___13*4
#5 = native hawaiian
single$race_NaHi<-single$demo_race_a_p___14*5
#6 = guam
single$race_guam<-single$demo_race_a_p___15*6
#7 = samoa
single$race_samoa<-single$demo_race_a_p___16*7
#8 = PI
single$race_PI<-single$demo_race_a_p___17*8
#9 = IndianAsian
single$race_AIndian<-single$demo_race_a_p___18*9
#10 = Chinese
single$race_Chinese<-single$demo_race_a_p___19*10
#11 = Filipino
single$race_Filipino<-single$demo_race_a_p___20*11
#12 = Japanese
single$race_Japanese<-single$demo_race_a_p___21*12
#13 = Korean
single$race_Korean<-single$demo_race_a_p___22*13
#14 = Viet
single$race_Viet<-single$demo_race_a_p___23*14
#15 = OtherAsian
single$race_OAsian<-single$demo_race_a_p___24*15

sumagain<-c("race_white", "race_black", "race_AmIn", "race_NaAl", "race_NaHi", "race_guam", "race_samoa", "race_PI", "race_AIndian", "race_Filipino", "race_Chinese",  "race_Japanese", "race_Korean", "race_Viet","race_OAsian")
single$race <- rowSums(single[, sumagain], na.rm = TRUE)
```
Drop extra columns
```{r}
# Drop specific columns by name
single <- single %>%
  select(-demo_race_a_p___10, -demo_race_a_p___11, -demo_race_a_p___12, -demo_race_a_p___13, -demo_race_a_p___14, -demo_race_a_p___15, -demo_race_a_p___16, -demo_race_a_p___17, -demo_race_a_p___18, -demo_race_a_p___19, -demo_race_a_p___20, -demo_race_a_p___21, -demo_race_a_p___22, -demo_race_a_p___23, -demo_race_a_p___24, -row_sum, -multiRacial, -race_white, -race_black, -race_AmIn, -race_NaAl, -race_NaHi, -race_guam, -race_samoa, -race_PI, -race_AIndian, -race_Filipino, -race_Chinese, -race_Japanese, -race_Korean, -race_Viet, -race_OAsian)
```
```{r}
names(multi)
multi <- multi %>%
  select(-demo_race_a_p___10, -demo_race_a_p___11, -demo_race_a_p___12, -demo_race_a_p___13, -demo_race_a_p___14, -demo_race_a_p___15, -demo_race_a_p___16, -demo_race_a_p___17, -demo_race_a_p___18, -demo_race_a_p___19, -demo_race_a_p___20, -demo_race_a_p___21, -demo_race_a_p___22, -demo_race_a_p___23, -demo_race_a_p___24,  -row_sum, -multiRacial)
```
```{r}
DEMOS_df<-rbind(single, multi)
```

```{r}
save.image(file = "/Users/gracer/Library/CloudStorage/OneDrive-UniversityofWyoming/0. Lab/M2AENAD Lab - Documents/RESEARCH/ABCD/Yana_SSIB_2024/data/demos.RData")
```

```{r}
screen_med_demo_df<-join(screen_med_df, DEMOS_df)
```


# Get columns of interest
```{r}
soda_interest<-c("subjectkey", "sex", "bkfs_soda")
anthro_interest<-c("subjectkey", "sex", "interview_age", "anthroheightcalc", "anthroweight1lb", "anthroweight2lb", "anthroweight3lb")
brain_interest<-c(4,8,23:191)
subcort_interest<-c(4,8,23:269)
#subset
soda_df<-soda_data[soda_interest]
anthro_df<-anthro_data[anthro_interest]
brain_df<-brain_data[,brain_interest]
subcort_df<-subcort_brain_data[,subcort_interest]
```


# Join the datasets into a single dataframe
```{r}
df0<-join(soda_df, anthro_df)
df0.1<-join(df0,brain_df)
df0.2<-join(df0.1,subcort_df)
#renaming the ID column, otherwise it won't be able to join
#names(anthro_data_2)[names(anthro_data_2) == 'src_subject_id'] <- 'subjectkey'
#df0.3<-join(df0.2, anthro_data_2)
#head(df0.3)
#DF<-df0.3
```


#Create groups for SSB
If you give it an upper limit you don't need the part with the 777 it would remove those also if you have -Inf you might be picking up inaccurate negative soda intake, best to keep the bottom as 0. I just copied and pasted this above, but for the next iteration do this. 

If I keep the bottom at 0, it says the breaks are incorrect.
It's okay to use -Inf here since the minimum is 0.

```{r}
summary(DF$bkfs_soda)
DF$ssb_group <- cut(DF$bkfs_soda,
                          breaks=c(-Inf, 0, 2, 10), 
                          labels=c('low', 'medium', 'high'))
```

# Get the mean weight
```{r}
DF$anthroweightcalc <- apply(X=DF[c("anthroweight1lb","anthroweight2lb", "anthroweight3lb")], MARGIN=1, FUN=mean, na.rm=TRUE)
```


# Calculate BMI and age in years
```{r}
DF$BMI<-(DF$anthroweightcalc/(DF$anthroheightcalc)^2)*703
DF$age_years<-DF$interview_age/12
```

# Calculate BMI%
```{r}
DF$bmi_perc <- childsds::sds(DF$BMI,
                    age = DF$age_years,
                    sex = DF$sex, male = "M", female = "F",
                    ref = cdc.ref,
                    item = "bmi",
                    type = "perc")
DF$bmi_perc
```
# remove exlcusion criteria (added 11/14/24)
```{r}
DF<-join(DF, screen_data)
```
- ADHD (scrn_commondx)
- scrn_cpalsy n = 2
- scrn_tumor
- scrn_stroke
- scrn_aneurysm
- scrn_hemorrhage n = 2
- scrn_hemotoma 
- scrn_medcond_other n = 121

- scrn_asd 1 = 98
- scrn_schiz1= 2

```{r}
DF1 <-subset(DF, DF$scrn_cpalsy != 0)
DF2 <- subset(DF1, DF1$scrn_hemorrhage != 0)
DF3 <- subset(DF2, DF2$scrn_medcond_other != 1)
DF4 <- subset(DF3, DF3$scrn_asd != 1)
DF5 <- subset(DF4, DF4$scrn_schiz != 1)
DF<-DF5
```

```{r}
names(DF)
```

#Drop missing values
```{r}
DF<-DF[complete.cases(DF), ]
```

#Find the class of all columns and then cast columns as factors or numeric as needed
Why the factoring does not work? It keeps appearing as a character.

```{r}
sapply(DF, class)
colnames(DF)
DF[,c(1,2,425:427)]<-sapply(DF[,c(1,2,425:427)], as.factor)
DF[,c(3:424)]<-sapply(DF[,c(3:424)], as.numeric)
```
# Test making income a ranked factor (works okay)

```{r}
# Cast the income as ordinal variables with the given levels
income_df <- DF
summary(as.factor(income_df$household.income.bl))

income_df$household.income.bl <- factor(income_df$household.income.bl, levels = c("[<50K]", "[>=100K]", "[>=50K & <100K]"))
```

# Releveling income at DF

```{r}
summary(as.factor(DF$household.income.bl))

DF$household.income.bl <- factor(DF$household.income.bl, levels = c("[<50K]", "[>=100K]", "[>=50K & <100K]"))
```



# Create high vs low, and low vs. medium datasets
Since low will be the reference group, we want to match based on the reference group
# we don't need medium
I am going to comment this out
```{r}
DFhigh_low<-subset(DF, DF$ssb_group != "medium")
#DFmedium_low<-subset(DF, DF$ssb_group != "high")

DFhigh_low$ssb_group<-factor(DFhigh_low$ssb_group)
#DFmedium_low$ssb_group<-factor(DFmedium_low$ssb_group)

```

# Perform initial matching with null to get an idea of differences
```{r}
m.out0 <- matchit(ssb_group ~ age_years + bmi_perc, data = DFhigh_low,
                 method = NULL, distance = "glm")
#m.out0.1 <- matchit(ssb_group ~ age_years + bmi_perc, data = DFmedium_low,
#                 method = NULL, distance = "glm")

```

```{r}
summary(m.out0)
```
# Perform matching using nearest neightbor (it works OK)
```{r}
m.out_highLow <- matchit(ssb_group ~ age_years + bmi_perc + household.income.bl, data = DFhigh_low,
                 method = "nearest", distance = "glm")

#m.out_mediumLow <- matchit(ssb_group ~ age_years + bmi_perc + household.income.bl, data = DFmedium_low,
#                 method = "nearest", distance = "glm")

```

# Get dataset from matched output
```{r}
highLow_DF <- match.data(m.out_highLow)

mediumLow_DF <- match.data(m.out_mediumLow)
```

# Subset the matched datasets into lows, mediums, and highs
```{r}
lows1<-subset(highLow_DF, highLow_DF$ssb_group == "low")
lows2<-subset(mediumLow_DF, mediumLow_DF$ssb_group == "low")
medium <-subset(mediumLow_DF, mediumLow_DF$ssb_group  != "low")
highs <-subset(highLow_DF, highLow_DF$ssb_group   != "low")
```

# We have more medium than low and high. Since we already matched them we can randomly select rows so that we have the same number in the medium group


```{r}
set.seed(123) # Setting a seed for reproducibility
mediums <- medium[sample(nrow(medium), 483), ] #was 513 in Grace's version, changed to 483 cuz now we have less lows&highs
```

# Join the low groups so we have the lows that match both the medium and high groups
```{r}
lows<-join(lows1, lows2)
```
# Use rbind to concatonate the low, medium, and high data back together
Now you have a dataset that is matched to the low group with equal group sizes.
```{r}
test<-rbind(lows, mediums)
test2<-rbind(test, highs)
summary(test2$ssb_group)
```

```{r}
library(psych)
describeBy(test2$bmi_perc, test2$ssb_group)
```


```{r}
head(test2)
#write.table(test2, "~/OneDrive - University of Wyoming/0. Lab/M2AENAD Lab - Documents/RESEARCH/ABCD/Yana_SSIB_2024/data/matched1.csv",  row.names = FALSE, sep = ",")

#rewrote in a different file
write.table(test2, r"(C:\Users\Yanko\University of Wyoming\M2AENAD Lab - Documents\M2AENAD Lab - Documents\RESEARCH\ABCD\Yana_SSIB_2024/data/matched2.csv)",  row.names = FALSE, sep = ",")
```

```{r}
hist(test2$bkfs_soda, main = "Distribution of soda per day \nn=1449 (soda intake groups matched on age, bmi% and household income)")
```

# Save the plot file
For some reason, it doesn't want to write to the lab OneDrive, so I saved it locally and then copied
```{r}
png(filename=r"(C:\Users\Yanko\OneDrive - University of Wyoming\Desktop - Copy\Lab\SSIB 2024\Scripts\0_Working\outputs\distribution_soda_per_day.png)")
hist(test2$bkfs_soda, main = "Distribution of soda per day \nn=1449 (soda intake groups matched on \nage, bmi% and household income)")
dev.off()
```


```{r}
#save.image(file = r"(C:\Users\Yanko\University of Wyoming\M2AENAD Lab - Documents\M2AENAD Lab - Documents\RESEARCH\ABCD\Yana_SSIB_2024\scripts\Scripts_Yana\Final_cleaning_data_scripts/matchedEnviro.RData)")
```

```{r}
load( "/Users/gracer/Library/CloudStorage/OneDrive-UniversityofWyoming/0. Lab/M2AENAD Lab - Documents/RESEARCH/ABCD/Yana_SSIB_2024/data/matchedEnviroFINALwithAdditional.RData")
#load(r"(C:\Users\Yanko\University of Wyoming\M2AENAD Lab - Documents\M2AENAD Lab - Documents\RESEARCH\ABCD\Yana_SSIB_2024\scripts\Scripts_Yana\Final_cleaning_data_scripts/matchedEnviro.RData)")
```



